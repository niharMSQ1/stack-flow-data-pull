{% extends "base.html" %}
{% block title %}Controls Management{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-6">Controls</h1>

  <!-- Filter Dropdown -->
  <div class="mb-4 bg-white p-4 rounded-lg shadow">
    <label for="source-filter" class="block text-sm font-medium text-gray-700 mb-2">
      Filter by Control Source:
    </label>
    <select id="source-filter" class="w-full md:w-1/3 p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
      <option value="">All Sources</option>
      <option value="TC">TrustCloud</option>
      <option value="ER">Eramba</option>
    </select>
  </div>

  <!-- Controls Table -->
  <div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Control</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clauses</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policies</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for control in controls %}
        <tr class="control-row" data-sources="{{ control.policies.all|join:","|lower }}">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-blue-700">{{ control.short_name }}</div>
            <div class="text-sm text-gray-500">{{ control.name }}</div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-600">{{ control.description }}</td>
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% for clause in control.clauses.all %}
              <span class="px-2 py-1 text-xs rounded-full cursor-pointer"
                    onclick="window.open('/clause/{{ clause.id }}/', '_blank')"
                    style="background-color:#E0E7FF;color:#3730A3">
                {{ clause.display_identifier }}
              </span>
              {% empty %}
              <span class="text-gray-400 text-xs">-</span>
              {% endfor %}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% for policy in control.policies.all %}
              <span class="px-2 py-1 text-xs rounded-full cursor-pointer"
                    onclick="window.open('/api/policy/{{ policy.id }}/', '_blank')"
                    data-source="{{ policy.policy_gathered_from }}"
                    {% cycle 'style=background-color:#FECACA;color:#991B1B' 'style=background-color:#CCFBF1;color:#134E4A' 'style=background-color:#FED7AA;color:#9A3412' as tagcolors %}>
                {{ policy.policy_id }}
              </span>
              {% empty %}
              <span class="text-gray-400 text-xs">-</span>
              {% endfor %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="px-6 py-4 text-center text-gray-500">No controls found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.getElementById('source-filter').addEventListener('change', function () {
    const selected = this.value;
    const rows = document.querySelectorAll('.control-row');

    rows.forEach(row => {
      const sourceTags = Array.from(row.querySelectorAll('[data-source]')).map(el => el.dataset.source);
      const matches = selected === '' || sourceTags.includes(selected);
      row.style.display = matches ? '' : 'none';
    });
  });
</script>
{% endblock %}
