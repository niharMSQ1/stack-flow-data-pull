{% extends "base.html" %}
{% block title %}Policies Management{% endblock %}

{% block content %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-6">Policies Management</h1>

  <!-- Filter Dropdown -->
  <div class="mb-4 bg-white p-4 rounded-lg shadow">
    <label for="security-group-filter" class="block text-sm font-medium text-gray-700 mb-2">
      Filter by Source or Security Group:
    </label>
    <select id="security-group-filter" class="w-full md:w-1/3 p-2 border rounded-md focus:ring-2 focus:ring-blue-500" onchange="filterPolicies()">
      <option value="ALL" {% if selected_group == 'ALL' %}selected{% endif %}>All Policies</option>
      <option value="ER" {% if selected_group == 'ER' %}selected{% endif %}>Eramba (Ungrouped)</option>
      <optgroup label="TrustCloud">
        {% for group in security_groups %}
          <option value="TC__{{ group }}" {% if selected_group == 'TC__'|add:group %}selected{% endif %}>{{ group }}</option>
        {% endfor %}
      </optgroup>
    </select>
  </div>

  <!-- Search Bar -->
  <div class="mb-6">
    <input
      type="text"
      id="policySearchInput"
      placeholder="Search policies by title, ID, or reference..."
      oninput="searchPolicies()"
      class="w-full md:w-1/3 p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
    />
  </div>

  <!-- Policies Table -->
  <div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy Title</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clauses</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Controls</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% if filtered_policies %}
          {% for policy in filtered_policies %}
          <tr class="policy-row security-group hover:bg-gray-50"
              data-group="{{ policy.security_group|default:'None' }}"
              data-title="{{ policy.title|default:'No Title'|lower }}"
              data-id="{{ policy.policy_id|default:''|lower }}"
              data-reference="{{ policy.policy_reference|default:''|lower }}">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-blue-700 hover:underline cursor-pointer"
                   onclick="showPolicyTemplate({{ policy.id }}, '{{ policy.title|escapejs }}')">
                {{ policy.title|default:"No Title" }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap font-mono relative cursor-pointer"
                onmouseenter="showTooltip(event, '/api/policy/{{ policy.id }}/')"
                onmouseleave="hideTooltip()"
                onclick="openPolicyInNewTab('/api/policy/{{ policy.id }}/')">
              <div class="text-sm text-blue-700 hover:text-blue-900">{{ policy.policy_id }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">{{ policy.policy_reference }}</div>
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-wrap gap-1">
                {% for clause in policy.clauses.all %}
                <span class="px-2 py-1 text-xs rounded-full cursor-pointer"
                      onclick="openClauseInNewTab(event, '{{ clause.id }}')"
                      onmouseenter="showTooltip(event, '/api/clause/{{ clause.id }}/')"
                      onmouseleave="hideTooltip()"
                      {% cycle 'style=background-color:#FEF3C7;color:#92400E' 'style=background-color:#E0E7FF;color:#3730A3' 'style=background-color:#FCE7F3;color:#9D174D' as tagcolors %}>
                  {{ clause.display_identifier }}
                </span>
                {% empty %}
                <span class="text-gray-400 text-xs">-</span>
                {% endfor %}
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-wrap gap-1">
                {% for control in policy.controls.all %}
                <span class="px-2 py-1 text-xs rounded-full cursor-pointer"
                      onclick="openControlInNewTab(event, '{{ control.id }}')"
                      onmouseenter="showTooltip(event, '/api/control/{{ control.id }}/')"
                      onmouseleave="hideTooltip()"
                      {% cycle 'style=background-color:#FECACA;color:#991B1B' 'style=background-color:#CCFBF1;color:#134E4A' 'style=background-color:#FED7AA;color:#9A3412' as controlcolors %}>
                  {{ control.short_name }}
                </span>
                {% empty %}
                <span class="text-gray-400 text-xs">-</span>
                {% endfor %}
              </div>
            </td>
          </tr>
          {% endfor %}
          <tr id="noResultsRow" class="hidden">
            <td colspan="5" class="px-6 py-4 text-center text-gray-400 italic">No matching policies found.</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">No policies found</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="policyTemplateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onclick="closePolicyModal()">
  <div class="modal-inner bg-white rounded-lg shadow-xl w-full max-w-3xl relative p-4 flex flex-col" onclick="event.stopPropagation()">
    <button onclick="closePolicyModal()" class="absolute top-2 right-4 text-gray-500 hover:text-gray-700 text-xl">&times;</button>

    <div class="flex space-x-4 mb-2 mt-2">
      <button id="viewTabBtn" onclick="switchTab('view')" class="px-4 py-2 rounded bg-blue-600 text-white">View</button>
      <button id="editTabBtn" onclick="switchTab('edit')" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800">Edit</button>
    </div>

    <!-- View Tab -->
    <div id="viewTab" class="overflow-y-auto prose pr-2 mb-2" style="max-height: 60vh;">
      <h2 id="policyTitleHeader" class="text-xl font-semibold text-gray-800 mb-4"></h2>
      <div id="policyTemplateContent"></div>
    </div>

    <!-- Edit Tab -->
    <div id="editTab" class="hidden flex flex-col w-full mt-2">
      <div id="policyTemplateEditor"
           class="bg-white border rounded p-3 w-full h-[50vh] text-sm leading-relaxed"></div>
      <div class="flex justify-end mt-3">
        <button onclick="savePolicyTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Snackbar -->
<div id="snackbar" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded shadow-md z-50 transition-opacity duration-300">
  <span id="snackbarText">Template not available</span>
</div>

<!-- Tooltip -->
<div id="tooltip-popup" class="hidden absolute bg-white border border-gray-300 shadow-lg rounded-lg p-3 text-sm z-50 max-w-xs">
  <div id="tooltip-loader" class="text-gray-400 italic">Loading...</div>
  <div id="tooltip-content" class="hidden"></div>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
let currentEditingPolicyId = null;
let quill;

document.addEventListener("DOMContentLoaded", () => {
  quill = new Quill("#policyTemplateEditor", {
    theme: "snow",
    placeholder: "Enter policy content here...",
    modules: {
      toolbar: [
        [{ header: [1, 2, false] }],
        ["bold", "italic", "underline"],
        ["link", "blockquote", "code-block"],
        [{ list: "ordered" }, { list: "bullet" }],
        ["clean"]
      ]
    }
  });
});

function filterPolicies() {
  const filter = document.getElementById('security-group-filter').value;
  const url = new URL(window.location.href);
  url.searchParams.set('group', filter);
  window.location.href = url.toString();
}

function searchPolicies() {
  const query = document.getElementById("policySearchInput").value.trim().toLowerCase();
  const rows = document.querySelectorAll(".policy-row");
  const noResults = document.getElementById("noResultsRow");

  let found = false;
  rows.forEach(row => {
    const title = row.getAttribute("data-title");
    const id = row.getAttribute("data-id");
    const ref = row.getAttribute("data-reference");

    const matches = title.includes(query) || id.includes(query) || ref.includes(query);
    row.style.display = matches ? "" : "none";
    if (matches) found = true;
  });

  if (noResults) {
    noResults.classList.toggle("hidden", found);
  }
}

function showTooltip(evt, url) {
  const tooltip = document.getElementById('tooltip-popup');
  const loader = document.getElementById('tooltip-loader');
  const content = document.getElementById('tooltip-content');

  tooltip.classList.remove('hidden');
  tooltip.style.top = (evt.pageY + 10) + 'px';
  tooltip.style.left = (evt.pageX + 10) + 'px';
  loader.classList.remove('hidden');
  content.classList.add('hidden');

  fetch(url)
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      loader.classList.add('hidden');
      content.classList.remove('hidden');
      content.innerHTML = `
        <div class="font-semibold text-gray-700 mb-1">${data.title || data.Title || data.short_name || "Details"}</div>
        ${data.reference_id ? `<div class="text-xs text-gray-600"><strong>Reference ID:</strong> ${data.reference_id}</div>` : ''}
        ${data.description ? `<div class="text-xs text-gray-600"><strong>Description:</strong> ${data.description}</div>` : ''}
      `;
    })
    .catch(() => loader.innerText = "Failed to load");
}

function hideTooltip() {
  document.getElementById('tooltip-popup').classList.add('hidden');
  document.getElementById('tooltip-content').innerHTML = '';
}

function openPolicyInNewTab(url) {
  window.open(url, '_blank');
}
function openClauseInNewTab(event, id) {
  event.stopPropagation();
  window.open(`/clause/${id}/`, '_blank');
}
function openControlInNewTab(event, id) {
  event.stopPropagation();
  window.open(`/control/${id}/`, '_blank');
}

function showPolicyTemplate(policyId, policyTitle = "Untitled Policy") {
  currentEditingPolicyId = policyId;

  fetch(`/api/policy/${policyId}/template/`)
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      const html = data.template || "";
      document.getElementById("policyTitleHeader").innerText = policyTitle;
      document.getElementById("policyTemplateContent").innerHTML = html;
      quill.root.innerHTML = html;

      switchTab('view');
      document.getElementById("policyTemplateModal").classList.remove("hidden");
    })
    .catch(() => showSnackbar("Template not available"));
}

function savePolicyTemplate() {
  const newContent = quill.root.innerHTML;
  fetch(`/api/policy/${currentEditingPolicyId}/template/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({ template: newContent })
  })
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(() => {
      showSnackbar("Template saved successfully");
      closePolicyModal();
    })
    .catch(() => showSnackbar("Error saving template"));
}

function switchTab(tab) {
  const viewTab = document.getElementById("viewTab");
  const editTab = document.getElementById("editTab");
  const viewBtn = document.getElementById("viewTabBtn");
  const editBtn = document.getElementById("editTabBtn");

  if (tab === 'view') {
    viewTab.classList.remove("hidden");
    editTab.classList.add("hidden");
    viewBtn.classList.add("bg-blue-600", "text-white");
    editBtn.classList.remove("bg-blue-600", "text-white");
    editBtn.classList.add("bg-gray-200", "text-gray-800");
  } else {
    editTab.classList.remove("hidden");
    viewTab.classList.add("hidden");
    editBtn.classList.add("bg-blue-600", "text-white");
    viewBtn.classList.remove("bg-blue-600", "text-white");
    viewBtn.classList.add("bg-gray-200", "text-gray-800");
  }
}

function closePolicyModal() {
  document.getElementById("policyTemplateModal").classList.add("hidden");
  currentEditingPolicyId = null;
}

function showSnackbar(message) {
  const snackbar = document.getElementById("snackbar");
  document.getElementById("snackbarText").innerText = message;
  snackbar.classList.remove("hidden");
  setTimeout(() => snackbar.classList.add("hidden"), 3000);
}

function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    const trimmed = cookie.trim();
    if (trimmed.startsWith(name + '=')) {
      return decodeURIComponent(trimmed.substring(name.length + 1));
    }
  }
  return '';
}
</script>

<style>
#tooltip-popup {
  pointer-events: none;
  position: absolute;
  transition: opacity 0.2s ease;
  background-color: #fff;
}

#policyTemplateModal .modal-inner {
  max-height: calc(100vh - 120px); /* avoid header + footer */
  margin-top: 64px;
  margin-bottom: 64px;
  overflow-y: auto;
}
</style>
{% endblock %}
