{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}SQ1{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    @keyframes grow {
      from { width: 0; }
      to { width: 100%; }
    }

    .loader-background {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(135deg, #0f172a, #1e3a8a, #3b0764);
      background-size: 600% 600%;
      animation: gradientMove 10s ease infinite;
      z-index: 9999;
      transition: opacity 1s ease;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .loader-core {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #e0f2fe;
      font-family: 'Courier New', monospace;
    }

    .core-seed {
      width: 60px; height: 60px;
      background: conic-gradient(from 0deg, #7c3aed, #ec4899, #06b6d4, #7c3aed);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
      margin: 0 auto 20px;
    }

    .loader-progress {
      width: 250px; height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px auto;
    }

    .loader-bar {
      height: 100%;
      background: linear-gradient(to right, #ec4899, #a78bfa, #22d3ee);
      animation: grow 4s linear forwards;
      width: 0;
    }

    .firefly, .particle {
      position: absolute;
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    .firefly {
      width: 6px; height: 6px;
      background: #fde68a;
      animation: flicker 1s infinite alternate;
    }

    .particle {
      width: 10px; height: 10px;
      background: radial-gradient(circle, #22d3ee 0%, transparent 60%);
    }

    .hidden-loader {
      opacity: 0;
      pointer-events: none;
    }

    /* Snackbar styles */
    .snackbar {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 16px;
      position: fixed;
      z-index: 10000;
      right: 30px;
      bottom: 100px;
      font-size: 14px;
    }

    .snackbar.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 100px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 100px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">
  <!-- Loader (only shown during actual sync) -->
  <div id="preloader" class="loader-background hidden-loader">
    <div class="loader-core">
      <div class="core-seed"></div>
      <div class="text-blue-200 text-xl animate-pulse font-bold">üîê Syncing SQ1 Data...</div>
      <div class="loader-progress">
        <div class="loader-bar" id="loader-bar"></div>
      </div>
      <div class="text-sm text-blue-100 mt-4 space-y-1">
        <div>üîÑ Updating database records...</div>
        <div>üìä Processing certifications...</div>
        <div>üìë Mapping policies to controls...</div>
      </div>
    </div>
  </div>

  <!-- Snackbar Notification -->
  <div id="snackbar" class="snackbar"></div>

  <!-- Header -->
  <header class="bg-white text-gray-800 p-4 flex items-center justify-between fixed top-0 left-0 w-full z-50 shadow">
    <div class="flex items-center gap-4">
      <img src="{% static 'images/1731000892786.svg' %}" alt="Logo" class="h-10 w-auto object-contain" />
      <div>
        <div class="text-xl font-semibold leading-none">
          <span class="text-purple-500">SQ</span><span class="text-pink-400">1</span>
        </div>
        <div class="text-sm text-gray-600">nxtgen cybersecurity</div>
      </div>
    </div>
    <div class="flex gap-3">
      <button id="sync-button" onclick="syncData()" class="bg-blue-100 text-blue-800 font-semibold px-4 py-2 rounded hover:bg-blue-200 transition">
        SYNC DATA
      </button>
      <a href="{% url 'certifications' %}" class="bg-purple-100 text-purple-800 font-semibold px-4 py-2 rounded hover:bg-purple-200 transition">CERTIFICATIONS</a>
      <a href="{% url 'policies' %}" class="bg-green-100 text-green-800 font-semibold px-4 py-2 rounded hover:bg-green-200 transition">POLICIES</a>
      <a href="{% url 'controls-section' %}" class="bg-orange-200 text-orange-900 font-semibold px-4 py-2 rounded hover:bg-orange-500 transition">CONTROLS</a>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 pt-24 pb-24">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white p-4 text-center fixed bottom-0 left-0 w-full z-50 shadow">
    <p>&copy; 2025 SQ1 Security</p>
  </footer>

  <!-- JavaScript -->
  <script>
    // Show loader before navigation
    window.onbeforeunload = function () {
      const loader = document.getElementById("preloader");
      const bar = document.getElementById("loader-bar");
      loader.style.display = "block";
      loader.classList.remove("hidden-loader");
      bar.style.animation = "grow 2s linear forwards";
    };

    // Hide loader when page fully loads
    window.onload = function () {
      const loader = document.getElementById("preloader");
      loader.classList.add("hidden-loader");
      setTimeout(() => loader.style.display = "none", 1000);
    };

    // Snackbar notification function
    function showSnackbar(message) {
      const snackbar = document.getElementById("snackbar");
      snackbar.textContent = message;
      snackbar.classList.add("show");
      setTimeout(() => snackbar.classList.remove("show"), 3000);
    }

    async function syncData() {
      const syncButton = document.getElementById('sync-button');
      
      // Check if sync is already in progress
      const lockCheck = await fetch('/check-sync-lock/');
      const lockData = await lockCheck.json();
      
      if (lockData.is_locked) {
        showSnackbar('‚ö†Ô∏è Sync is already in progress');
        return;
      }

      const loader = document.getElementById("preloader");
      const bar = document.getElementById("loader-bar");
      loader.style.display = "block";
      loader.classList.remove("hidden-loader");
      bar.style.animation = "grow 8s linear forwards";

      try {
        // Acquire lock
        await fetch('/acquire-sync-lock/');
        
        const endpoints = [
          "/populate-database",
          "/map-controls-with-policy",
          "/pulling_eramba_certifications/",
          "/ingest-eramba-policies/",
          "/get-eramaba-clauses/",
          "/get-eramaba-controls/",
          "/map-eramba-clauses-controls/",
          "/assembling-trustcloud-controls/",
          "/assign-clause-parents/",
          "/trust_cloud_templates/"
        ];

        for (let url of endpoints) {
          try {
            const response = await fetch(url);
            if (!response.ok) {
              console.error(`Failed on ${url}:`, response.statusText);
            }
          } catch (err) {
            console.error(`Error during ${url}:`, err);
          }
        }

        showSnackbar('‚úÖ Data sync completed!');
      } catch (error) {
        console.error('Sync error:', error);
        showSnackbar('‚ùå Sync failed - check console');
      } finally {
        // Release lock
        await fetch('/release-sync-lock/');
        
        loader.classList.add("hidden-loader");
        setTimeout(() => loader.style.display = "none", 1000);
      }
    }
  </script>
</body>

</html>